#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_PRECOMMIT:-0}" == "1" ]]; then
  echo "[pre-commit] SKIP_PRECOMMIT=1, skipping checks."
  exit 0
fi

if ! command -v pnpm >/dev/null 2>&1; then
  echo "[pre-commit] pnpm is required for repository checks." >&2
  exit 1
fi

run() {
  echo "[pre-commit] $1"
  shift
  "$@"
}

PRETTIER_FILES=()
while IFS= read -r file; do
  [[ -n "$file" ]] && PRETTIER_FILES+=("$file")
done < <(
  git diff --cached --name-only --diff-filter=ACM --relative \
    | grep -E '\.(astro|jsx?|tsx?|mjs|cjs|json|ya?ml|mdx?|css|scss)$' \
    || true
)

if (( ${#PRETTIER_FILES[@]} )); then
  echo "[pre-commit] Formatting ${#PRETTIER_FILES[@]} staged file(s) with Prettier"
  pnpm exec prettier --plugin=prettier-plugin-astro --write "${PRETTIER_FILES[@]}"
  git add -- "${PRETTIER_FILES[@]}"
  run "Prettier format check" pnpm exec prettier --plugin=prettier-plugin-astro --check "${PRETTIER_FILES[@]}"
else
  echo "[pre-commit] No staged files matched Prettier patterns"
fi

if [[ -d node_modules/@astrojs/check || -d apps/blog/node_modules/@astrojs/check ]]; then
  run "Astro lint" pnpm --filter alexander-blog run lint
else
  echo "[pre-commit] Skipping astro check: @astrojs/check not installed."
fi

run "Vitest" pnpm --filter alexander-blog run test:unit
run "Playwright" pnpm --filter alexander-blog run test:e2e
