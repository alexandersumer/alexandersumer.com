---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const entry = slug ? await getEntryBySlug('blog', slug) : undefined;
if (!entry) {
  throw new Error(`Post not found for slug: ${slug}`);
}

const { Content, data } = await entry.render();
const adjacent = (await getCollection('blog'))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
const currentIndex = adjacent.findIndex((post) => post.slug === entry.slug);
const previous = currentIndex > 0 ? adjacent[currentIndex - 1] : undefined;
const next = currentIndex >= 0 && currentIndex < adjacent.length - 1 ? adjacent[currentIndex + 1] : undefined;
const ogImage = `/blog/${entry.slug}/social-image.png`;
---
<BaseLayout
  title={`${data.title} – alexandersumer.com`}
  description={data.description}
  ogImage={ogImage}
  canonical={`/blog/${entry.slug}/`}
>
  <article class="prose dark:prose-invert">
    <p class="text-sm opacity-70">{data.pubDate.toLocaleDateString()}</p>
    <h1>{data.title}</h1>
    {data.updatedDate && (
      <p class="text-xs opacity-60">Updated {data.updatedDate.toLocaleDateString()}</p>
    )}
    {data.tags.length > 0 && (
      <p class="text-sm opacity-70">Tags: {data.tags.join(', ')}</p>
    )}
    <Content />
  </article>

  <nav class="mt-12 flex flex-col gap-4 not-prose">
    {previous && (
      <a class="text-sm" href={`/blog/${previous.slug}/`}>
        ← Previous: {previous.data.title}
      </a>
    )}
    {next && (
      <a class="text-sm" href={`/blog/${next.slug}/`}>
        Next: {next.data.title} →
      </a>
    )}
  </nav>

  <section class="mt-12">
    <script
      src="https://giscus.app/client.js"
      data-repo="YOUR_GITHUB_USERNAME/YOUR_DISCUSSIONS_REPO"
      data-repo-id="REPLACE_WITH_REPO_ID"
      data-category="General"
      data-category-id="REPLACE_WITH_CATEGORY_ID"
      data-mapping="pathname"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async
    ></script>
    <div class="giscus" />
  </section>
</BaseLayout>
